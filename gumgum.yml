---
  - hosts: webservers
    become: yes
    become_method: sudo
    tasks:
      - name: Update and upgrade apt packages
        become: true
        apt:
         upgrade: yes
         update_cache: yes
         cache_valid_time: 86400
      - name: install nginx server in ubuntu 14.04 LTS
        apt: name={{item}} state=present update_cache=true
        with_items:
          - python
          - python-pip
          - python-dev
          - nginx
          - git
  - hosts: webservers
    become: yes
    become_method: sudo
    tasks:

      - name: create directory
        file: path=/opt/releases/{{ app_name }} state=directory
      - name: installing virtual environment
        pip:
         name: virtualenv
      - name: create virtual environment
        command: "{{ item }} chdir=/opt/releases/{{ app_name }}"
        with_items:
          - virtualenv flaskappenv
      - name: install flask and gunicorn within virtualenv
        pip: name={{item}} virtualenv=/opt/releases/flaskapp/flaskappenv
        with_items:
            - flask
            - gunicorn
      - name: clone repo
        git:
          repo: https://github.com/{{ github_user}}/{{ app_name }}.git
          dest: /opt/releases/{{ app_name }}
          update: yes

  - hosts: webservers
    become: yes
    become_method: sudo
    tasks:
    - name: configure app to be upstart script
      copy:
        src: path=/opt/releases/{{app_name}}/{{ app_name }}.conf
        dest: path=/etc/init/{{ app_name }}.conf
